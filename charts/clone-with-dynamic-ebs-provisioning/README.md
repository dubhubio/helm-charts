# DubHub Clone Helm Chart

This Helm chart deploys the dubhub `clone` application in a Kubernetes cluster, which starts a database clone based on a snapshot generated by dubhub.

## Prerequisites

- Kubernetes 1.12+
- Helm 3.0+
- Access to an ECR that hosts a dubhub snapshot image
- A storage class to provision persistent volumes, see configs/storge-class.yaml

## Installing the Chart

To install the chart with the release name `my-release`, use the following command:

    helm install my-release ./clone-with-dynamic-ebs-provisioning

## Uninstalling the Chart

To uninstall/delete the `my-release` deployment, use the following command:

    helm delete my-release

This command removes all the Kubernetes components associated with the chart and deletes the release.

## Configuration

The following table lists the configurable parameters of the `dubhub-clone` chart and their default values.

| Parameter                  | Description                                                                         | Default                   |
|----------------------------|-------------------------------------------------------------------------------------|---------------------------|
| `image.repository`         | Image repository                                                                    | `<your-ecr>`              |
| `image.pullPolicy`         | Image pull policy                                                                   | `IfNotPresent`            |
| `image.tag`                | Image tag (defaults to Chart's `appVersion`)                                        | `latest`                  |
| `service.type`             | Kubernetes Service type                                                             | `ClusterIP`               |
| `service.port`             | Kubernetes Service port                                                             | `5432`                    |
| `env[0].name`              | Environment variable name for the password                                          | `PASSWORD`                |
| `env[0].value`             | Environment variable value for the password                                         | `<your-password>`         |
| `env[1].name`              | Environment variable name for the U value                                           | `U`                       |
| `env[1].value`             | Environment variable value for the U value                                          | `<your-U-value>`          |
| `env[2].name`              | Environment variable name for the clone UUID                                        | `UUID`                    |
| `env[2].value`             | Environment variable value for the clone UUID                                       | `<your-UUID-value>`       |
| `env[3].name`              | Environment variable name for the clone backup schedule                             | `BACKUP_SCHEDULE`         |
| `env[3].value`             | Environment variable value for the backup schedule in cron format (optional)        | `<backup-schedule>`       |
| `env[4].name`              | Environment variable name for the clone backup directory                            | `BACKUP_DIR`              |
| `env[4].value`             | Environment variable value for the clone backup directory (optional)                | `/dubhub/backups`         |
| `env[5].name`              | Environment variable name for the number of backups that are saved                  | `MAX_BACKUPS`             |
| `env[5].value`             | Environment variable value for the number of backups that are saved (optional)      | `<num-of-backups>`        |
| `env[6].name`              | Environment variable name for monitoring available space                            | `SPACE_USAGE_MIN_PERCENT` |
| `env[6].value`             | Environment variable value for the min amount of available space allowed (optional) | `<min-usage-percent>`     |
| `imagePullSecrets[0].name` | Name of the secret for image pulling                                                | `<your-secret-name>`      |
| `storage.size`             | Size of the volume                                                                  | `<volume-size>`           |
| `storage.storageClassName` | Name of the storage class to provision the volumes                                  | `<storage-class-name>`    |

For more information on configuring the `imagePullSecrets`, especially when using AWS ECR, see the [Configuring Image Pull Secret for AWS ECR](#configuring-image-pull-secret-for-aws-ecr) section below.

## Configuring Image Pull Secret for AWS ECR

The `imagePullSecret` required by this Helm chart is not a regular AWS Secret but a Kubernetes secret that allows Kubernetes to pull images from ECR. This secret is generated using credentials obtained from AWS and is used by Kubernetes to authenticate with ECR.

To create an `imagePullSecret` for your Kubernetes cluster that allows pulling images from AWS ECR, follow these steps:

1. Ensure you have the AWS CLI installed and configured with the necessary permissions to access ECR.

2. Run the following command to obtain an authentication token and generate a Kubernetes secret:

    ```bash
    aws ecr get-login-password --region <your-region> | kubectl create secret docker-registry <your-secret-name> --docker-server=<aws_account_id>.dkr.ecr.<your-region>.amazonaws.com --docker-username=AWS --docker-password-stdin
    ```

    Replace `<your-region>` with your AWS region, `<your-secret-name>` with a name for your Kubernetes secret, and `<aws_account_id>` with your AWS account ID.

3. Once the secret is created, you can reference it in your `values.yaml` under the `imagePullSecrets` section:

    ```yaml
    imagePullSecrets:
      - name: <your-secret-name>
    ```

    Replace `<your-secret-name>` with the name you used when creating the secret.

This Kubernetes secret will be used by the Helm chart to authenticate with AWS ECR and pull your Docker images.

## Customizing the Chart Before Installing

To configure the chart with custom values, you can:

1. Edit the `values.yaml` file directly.
2. Use the `--set` flag on the command line to override specific parameters:

    ```
    helm install my-release ./clone \
      --set image.repository=my-custom-repository,env[0].value=my-custom-password
    ```

3. Provide a custom `values.yaml` file during installation:

    ```
    helm install my-release ./clone -f my-values.yaml
    ```

## Running Custom Initialization Commands

Any additional SQL commands that are required to run after the clone is up (for example, creating a database) can be updated in the configmap.yaml file under the init_clone.sql section.


For more information on configuring the Helm chart, refer to the Helm chart documentation.
